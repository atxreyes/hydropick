#
# Copyright (c) 2014, Texas Water Development Board
# All rights reserved.
#
# This code is open-source. See LICENSE file for details.
#

from __future__ import absolute_import

import numpy as np
from shapely.geometry import LineString

from traits.api import (HasTraits, Array, Dict, Event, Instance, List,
                        Supports, Str, provides, CFloat, Tuple)

from .i_core_sample import ICoreSample
from .i_survey_line import ISurveyLine


@provides(ISurveyLine)
class SurveyLine(HasTraits):
    """ A class representing a single survey line """

    #: the user-visible name for the line
    name = Str

    #: sample locations, an Nx2 array (example: easting/northing?)
    locations = Array(shape=(None, 2))

    #: specifies unit for values in locations array
    locations_unit = Str('feet')

    #: array of associated lat/long available for display
    lat_long = Array(shape=(None, 2))

    #: a dictionary mapping frequencies to intensity arrays
    frequencies = Dict

    #: intensity array shape for convenience (num_depth_pts, num_distance_pts)
    shape = Tuple

    #: relevant core samples
    core_samples = List(Supports(ICoreSample))

    #: depth of the lake at each location as generated by various soruces
    lake_depths = Dict(Str, Array)

    # and event fired when the lake depths are updated
    lake_depths_updated = Event

    #: The navigation track of the survey line in map coordinates
    navigation_line = Instance(LineString)

    #: pre-impoundment depth at each location as generated by various soruces
    preimpoundment_depths = Dict(Str, Array)

    # and event fired when the lake depth is updated
    preimpoundment_depths_updated = Event

    #: Depth corrections:
    #:  depth = (pixel_number_from_top * pixel_resolution) + draft - heave
    #: distance from sensor to water. Constant offset added to depth
    draft = CFloat

    #: array of depth corrections.  Changes vertical offset of each column.
    heave = Array

    #: pixel resolution, depth/pixel
    pixel_resolution = CFloat

    # XXX probably other metadata should be here

    def load_data(self, hdf5_file):
        ''' Called by UI to load this survey line when selected to edit
        '''
        from ..io import survey_io

        # read frequency dict from hdf5 file.
        freq_dict_list = survey_io.read_frequency_data_from_hdf(hdf5_file, self.name)

        # fill frequncies and lake depths dictionaries with freqs as keys.
        for freq_dict in freq_dict_list:
            key = freq_dict['kHz']
            # transpose array to go into image plot correctly oriented
            intensity = freq_dict['intensity'].T
            self.frequencies[str(key)] = intensity
            self.shape = intensity.shape
            lake_key = 'Lakedepth_{:.1f}'.format(key)
            self.lake_depths[lake_key] = freq_dict['depth_r1']

        # for all other traits, take from first freq, assuming identical
        freq_dict = freq_dict_list[0]
        self.locations = np.vstack([freq_dict['interpolated_easting'],
                                   freq_dict['interpolated_northing']]).T
        self.lat_long = np.vstack([freq_dict['latitude'],
                                  freq_dict['longitude']]).T
        self.draft = (np.mean(freq_dict['draft']))
        self.heave = freq_dict['heave']
        self.pixel_resolution = (np.mean(freq_dict['pixel_resolution']))
